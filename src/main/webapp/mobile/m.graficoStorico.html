<!-- ***************************************************************************
*Copyright (c) 2014 Proxima Centauri srl <info@proxima-centauri.it>.
* All rights reserved. This program and the accompanying materials
* are made available under the terms of the GNU Public License v3.0
* which accompanies this distribution, and is available at
* http://www.gnu.org/licenses/gpl.html
*  
* Contributors:
*     Proxima Centauri srl <info@proxima-centauri.it> - initial API and implementation
**************************************************************************** -->

<script>
$(document).ready(function() {
	//check the place from session storage
	var place = GetURLParameter('place', sessionStorage.getItem('url'));
	console.log(place);
	
	if(place=="verres"){
		query_db = verres_query_db;
		query_dwh = verres_query_dwh;
	}
	else if(place=="mirafiori"){
		query_db = mirafiori_query_db;
		query_dwh = mirafiori_query_dwh;
	}
//prendo un intervallo di tempo da oggi a 1 mese fa
	
	//prendo giorno, mese, anno corrente
	//prendo la data
	var currentDate_storico = moment();
	
	var anno_storico = currentDate_storico.year();
	var mese_storico = currentDate_storico.month()+1;
	var giorno_storico = currentDate_storico.date();
	
	//devo prendere anno, mese, giorno di 30 giorni fa 
	var lastMonthBegin_storico = currentDate_storico.subtract('days', 30);
	var lastanno_storico = lastMonthBegin_storico.year();
	var lastmese_storico = lastMonthBegin_storico.month()+1;
	var lastgiorno_storico = lastMonthBegin_storico.date();
	
	dograficoStorico(lastanno_storico, lastmese_storico, lastgiorno_storico, anno_storico, mese_storico, giorno_storico);

});

function dograficoStorico(lastanno, lastmese, lastgiorno, anno, mese, giorno){
	
	var time_value_array = new Array();
	
	var num_axes;
	
	//devo prendere il parametro totalenergy 
	var drain = GetURLParameter("totalenergy",sessionStorage.getItem('url'));
	
	var query_history = build_interval_query_energy(drain, lastanno,lastmese, lastgiorno, null, null, anno, mese, giorno, null, null, true);
	console.log("query history " + query_history);
	
	$.ajax({
		dataType : "jsonp",
		url : query_history,
		error : function(x, t, r) {
			var scritta = $("<p class='errorMessage'>").text("Data are temporarily not available. Try to refresh the page");
			$("#graficoStorico").empty(); 
			$("#graficoStorico").append(scritta); 
		},
		success : function(data) {
			console.log(data);
			console.log("success query grafico storico");
			time_value_array=parse_time_value_data(data, 1000);
		},
		
		complete : function (qXHR, textStatus){
			console.log("complete query grafico storico");
			if(time_value_array.length>0){
				// create the chart 
				var chart = new Highcharts.StockChart ({
				    chart: {
				    	renderTo: 'graficoStorico',
				        alignTicks: false
				    },

				    colors : [ '#4DBD33' ],
				    
				    title: {
				        text: 'Daily Consumption (kWÂ·h)'
				    },
				    rangeSelector: {
				        buttons: [{
				            type: 'day',
				            count: 3,
				            text: '3d'
				        }, {
				            type: 'week',
				            count: 1,
				            text: '1w'
				        }, {
				            type: 'all',
				            text: 'All'
				        }],
				    	labelStyle: {
				    		color: 'silver',
				    		fontWeight: 'bold'
				    	},
				    	inputStyle: {
				    		color: 'silver'
				    	},
				        selected: 3
				    },
				    series: [{
				    	type: 'column',
				        name: 'Daily Consumption',
				        data: time_value_array,
				          dataGrouping: {
				    	   dateTimeLabelFormats: {
				    		   day: ['%A, %b %e, %Y', '%A, %b %e', '-%A, %b %e, %Y'],
				    		   week: ['Week from %A, %b %e, %Y', '%A, %b %e', '-%A, %b %e, %Y'],
				    		   month: ['%B %Y', '%B', '-%B %Y'],
				    		   year: ['%Y', '%Y', '-%Y']
				    	   },
							units: [[
							    'day',
							    [1]
							],[
								'week', // unit name
								[1] // allowed multiples
							], [
								'month',
								[1, 2, 3]
							]]
				        }  
				    }]
				});
			}
			
			else{
				var scritta = $("<p class='errorMessage'>").text("Data are temporarily not available. Try to refresh the page");
				$("#graficoStorico").append(scritta); 
			}
			
		}
	});
}

</script>




<div id="graficoStorico"></div>
