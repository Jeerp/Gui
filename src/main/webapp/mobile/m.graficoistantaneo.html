<!-- ***************************************************************************
*Copyright (c) 2014 Proxima Centauri srl <info@proxima-centauri.it>.
* All rights reserved. This program and the accompanying materials
* are made available under the terms of the GNU Public License v3.0
* which accompanies this distribution, and is available at
* http://www.gnu.org/licenses/gpl.html
*  
* Contributors:
*     Proxima Centauri srl <info@proxima-centauri.it> - initial API and implementation
**************************************************************************** -->

<script >
var name, unit, value;
var query_ist;
var g;
//min e max per il gauge
var max;

var url = sessionStorage.getItem('url');
var totalpower = GetURLParameter('totalpower', url);

//check the place from session storage
var place = GetURLParameter('place', url);

if(place=="verres"){
	query_db = verres_query_db;
	query_dwh = verres_query_dwh;
}

query_ist = build_instant_query(totalpower);

var query_last_hour_tot = query_db + totalpower+"?limit=360";
var last_hour_tot = new Array();
//prendo la larghezza del pixel in div
var w1 = $('.grafico_istantaneo').width();
$('#gauge').css({
	width: w1,
	height: w1/1.25
});



	console.log(query_ist);
	//variabili per i dati del grafico
	//chiamata ajax per il dato
	$.ajax({
		url : query_ist,
		dataType : "jsonp",
		error : function(x, t, r) {
			console.log(x.response.message); 
		},
		success : function(data) {
			console.log("success");
			name = data.name;
			value = data.measures[0].value;
			console.log(value);
		},
		complete : function(qXHR, textStatus) {
			var label = "W";
			if(value>10000){
				value = (value/1000).toFixed(2);
				label = "kW";
			}
			else{
				value = value.toFixed(0);
			}
			
			var newvalue = parseFloat(value)+parseFloat((value/3));
			max = Math.pow(10,(Math.ceil(log10(newvalue))));
			
			
			//se il div che contiene il grafico ha giÃ  il contenuto
			if ($("#gauge").text().length > 0) {
			     //lo svuoto
			     $("#gauge").empty();
			}
			
			g = new JustGage({
			    id: "gauge", 
			    value: value, 
			    valueFontColor: 'white',
			    min: 0,
			    max: max,
			    title: "Current Consumption",
			    titleFontColor: "white",
			    label: label
			  }); 
			setInterval(function(){
				$.ajax({
					url : query_ist,
					dataType : "jsonp",
					error : function(x, t, r) {
						console.log(x.response.message); 
					},
					success : function(data) {
						console.log("success");
						name = data.name;
						value = data.measures[0].value;
						value = value;
					},
					complete : function(qXHR, textStatus) {
						var label = "W";
						if(value>10000){
							value = (value/1000).toFixed(2);
							label = "kW";
						}
						else{
							value = value.toFixed(0);
						}
						
						g.refresh(value);
					}
				//fine chiamata ajax
				});
			}, 10000);
		}
	//fine chiamata ajax
	});
	
	//anche qui inserisco max e min
	//faccio chiamata ajax per avere i valori dell'ultima ora (la rifaccio ogni ora)
	$.ajax({
		url : query_last_hour_tot,
		dataType : "jsonp",
		error : function(x, t, r) {
			console.log(x.response.message);
		},
		success : function(data) {
			console.log("success query ultima ora");
			//memorizzo nel vettori i dati
			count = data.count;
			
			for(var i=0; i<count; i++){
				last_hour_tot[i] = data.measures[i].value.toFixed(0);
			}

		},
		complete : function(qXHR, textStatus) {
			//ordino
			last_hour_tot.sort(function (a,b) {
			    return a - b;
			});
			var min = last_hour_tot[0];
			$("#span_min_tot").html(min);
			var max = last_hour_tot[count-1];
			$("#span_max_tot").html(max);
			//lo inserisco negli span
			
			setInterval(function() {
				$.ajax({
					url : query_last_hour_tot,
					dataType : "jsonp",
					error : function(x, t, r) {
						console.log(x.response.message);
					},
					success : function(data) {
						console.log("success query ultima ora");
						//memorizzo nel vettori i dati
						count = data.count;
						
						for(var i=0; i<count; i++){
							last_hour_tot[i] = data.measures[i].value.toFixed(0);
						}
					},
					complete : function(qXHR, textStatus) {
						//ordino
						last_hour.sort(function (a,b) {
						    return a - b;
						});
						//lo inserisco negli span
						var min = last_hour_tot[0];
						$("#span_min_tot").html(min);
						var max = last_hour_tot[count-1];
						$("#span_max_tot").html(max);
						
					}
				//fine chiamata ajax
				});
			}, 60*60*1000);
		}
	//fine chiamata ajax
	});
		
</script> 


	<div class="grafico_istantaneo" >
		<div id="gauge"></div>
	</div>

	
