<!-- ***************************************************************************
*Copyright (c) 2014 Proxima Centauri srl <info@proxima-centauri.it>.
* All rights reserved. This program and the accompanying materials
* are made available under the terms of the GNU Public License v3.0
* which accompanies this distribution, and is available at
* http://www.gnu.org/licenses/gpl.html
*  
* Contributors:
*     Proxima Centauri srl <info@proxima-centauri.it> - initial API and implementation
**************************************************************************** -->

<script type="text/javascript">

	var chart1;

	var yesterday_values = new Array();
	var today_values = new Array();

	var timer;
	//prima ora in cui si visualizzano i dati
	var first_hour = 9;
	//variabili per memorizzare data corrente
	var date;
	var hour;
	var current_hour;
	var query_yesterday;
	var query_today;
	
	var count;
	
	//NB: ho forzato le due chiamate ajax come sincrone, cos� non dovrebbero esserci problemi per il grafico

				
				clearInterval(timer);

				//prendo data, mese e anno corrente
				//uso funzioni di moment.js

				/*OGGI*/
				var day = moment().date();
				var month = moment().month() +1; //perch� il mese parte da zero
				var year = moment().year();
				//devo prendere l'ora corrente
				var current_hour = moment().hour();
				var query_today_current_hour = moment().subtract('hour',1).hour();
				//calcolo le tre ore precedenti
				var prev_hour = moment().subtract('hour',2).hour();
				
				//in base a questo costruisco anche l'array con le categories
				var categories = [
				                 	moment().subtract('hour',2).hour()+"-"+moment().subtract('hour',1).hour(),
				                 	moment().subtract('hour',1).hour()+"-"+moment().hour(),
				                 	moment().hour()+"-"+moment().add('hour',1).hour()
				                 ];
				
				
				/*IERI*/
				var yesterday = moment().subtract('days', 1);
				console.log(yesterday);
				var yesterday_day = yesterday.date();
				var yesterday_month = yesterday.month() + 1;
				var yesterday_year = yesterday.year();
				
				console.log(day + " " + month + " " + year);
				console.log(yesterday_day + " " + yesterday_month + " " + yesterday_year);
				
				//in base al parameter, costruisco la query
				
				//prendo anche la location nel db 
				var url = sessionStorage.getItem('url');
				var drain = GetURLParameter("totalenergy", url);
				
				//check the place from session storage
				var place = GetURLParameter('place', url);
				console.log(place);
				
				if(place=="verres"){
					query_db = verres_query_db;
					query_dwh = verres_query_dwh;
				}
				else if(place=="mirafiori"){
					query_db = mirafiori_query_db;
					query_dwh = mirafiori_query_dwh;
				}
				
				query_yesterday = build_interval_query_energy(drain, yesterday_year, yesterday_month, yesterday_day, prev_hour, null, yesterday_year, yesterday_month, yesterday_day, current_hour, null, false );
				console.log("query yesterday "+query_yesterday);
				
				$.ajax({
					url : query_yesterday,
					type : "GET",
					dataType : "jsonp",
					async : false,
					success : function(data) {
						console.log("ajax success");
						yesterday_values = parse_simple_data(data, 1000);
					},
					error : function(xhr, ajaxOptions, thrownErrorxhr) {
						console.log(xhr.status);
						console.log(thrownErrorxhr.message);
						var scritta = $("<p class='errorMessage'>").text("Data are temporarily not available. Try to refresh the page.");
						$(".grafico_centrale").append(scritta);
					},
					complete : function(qXHR, textStatus) {
						
						if(yesterday_values.length>0){
							chart1 = new Highcharts.Chart({
								chart : {
									renderTo : 'chart',
									type : 'column',
								},
								colors : [ '#F15A24', '#0071BC' ],
								legend : {
									align : 'center',
									layout : 'horizontal',
									verticalAlign : 'top',
									y:40
								},
								title : {
									text : 'Energy Consumed per Hour'
								},
								xAxis : {
									categories : categories
								},
								yAxis : {
									title : {
										text : 'kW·h',
									}
								},
								series : [ {
									name : 'YESTERDAY',
									data : yesterday_values
								}, {
									name : 'TODAY',
									data : [ 0, 0, 0 ]
								} ]
							}, function(chart1) {

								hour = 9;
								console.log("hour " + hour);
								date = new Date();
								current_hour = date.getHours();
								console.log("current " + current_hour);
								console.log("hour " + hour);
								if (current_hour > hour) {
									query_today = build_interval_query_energy(drain, year, month, day, prev_hour, null, year, month, day,  query_today_current_hour, null, false);
								
									console.log("query today " + query_today);

									//chiamata ajax
									$.ajax({
										url : query_today,
										type : "GET",
										dataType : "jsonp",
										async : false,
										success : function(data) {
											//aggiorno hour solo se la chiamata ajax � andata a buon fine
											hour = current_hour;
											//prendo i valori e li metto nell'array today
											today_values = parse_simple_data(data, 1000);
											
										},
										error : function(xhr, ajaxOptions, thrownErrorxhr) {
											console.log(xhr.status);
											console.log(thrownErrorxhr.message);
										},
										complete : function(qXHR, textStatus) {
											//devo aggiornare i valori della serie che si riferisce ad oggi
											for ( var i = 0; i < today_values.length; i++) {
												var point = chart1.series[1].points[i];
												var newVal = today_values[i];
												point.update(newVal);
											}
										}
									});
								}

								//ogni 10 min controllo se è cambiata l'ora
								timer = setInterval(function() {
									date = new Date();
									current_hour = date.getHours();									
									console.log("current " + current_hour);
									console.log("hour " + hour);
									if (current_hour > hour) {
										query_today = build_interval_query_energy(drain, year, mont, day, prev_hour, null, year, month, day,  current_hour-1, null, false);
										
										console.log(query_today);

										//chiamata ajax
										$.ajax({
											url : query_today,
											type : "GET",
											dataType : "jsonp",
											async : false,
											success : function(data) {
												//aggiorno hour solo se la chiamata ajax � andata a buon fine
												hour = current_hour;
												today_values = parse_simple_data(data, 1000);
							
											},
											error : function(xhr, ajaxOptions, thrownErrorxhr) {
												console.log(xhr.status);
												console.log(thrownErrorxhr.message);
											},
											complete : function(qXHR, textStatus) {
												//devo aggiornare i valori della serie che si riferisce ad oggi
												for ( var i = 0; i < today_values.length; i++) {
													var point = chart1.series[1].points[i];
													var newVal = today_values[i];
													point.update(newVal);
												}
											}
										});
									}

								}, 10 * 60 * 1000);

							});
						}
						else {
							var scritta = $("<p class='errorMessage'>").text("Data are temporarily not availabe. Try to refresh the page.");
							$(".grafico_centrale").append(scritta);
						}
						
					}
				});

</script>

<div class="grafico_centrale">

	<div id="chart"></div>
</div>
